<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeText - Configuración de Patrones</title>
    <link rel="stylesheet" href="../static/styles.css">
</head>
<body>
<header>
    <div class="header-content">
        <h1>SafeText <span class="subtitle">Sistema de Detección de Ciberacoso Escolar</span></h1>
    </div>
    <div class="header-year">
        <span>EPN 2025</span>
    </div>
</header>

<main>
    <div class="config-container">
        <div class="config-nav">
            <a href="index.html" class="btn-back">← Volver al Inicio</a>
            <h2>Configuración de Patrones</h2>
        </div>

        <!-- Tabla de patrones -->
        <div class="patterns-section">
            <h3>Patrones a detectar</h3>
            <div class="table-container">
                <table class="patterns-table" id="patterns-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Mensaje</th>
                            <th>Gravedad</th>
                            <th>Categoría</th>
                            <th>Etiqueta</th>
                        </tr>
                    </thead>
                    <tbody id="patterns-tbody"></tbody>
                </table>
            </div>
            <div class="pagination" id="pagination"></div>
        </div>

        <!-- Subir archivo -->
        <div class="upload-patterns-section">
            <h3>Subir archivo de patrones (CSV o TXT)</h3>
            <input type="file" id="pattern-file" accept=".csv,.txt">
            <button class="btn-secondary" id="upload-patterns-btn">Subir archivo</button>
        </div>

        <!-- Lista de archivos cargados -->
        <div class="files-section">
            <h3>Archivos cargados</h3>
            <table class="patterns-table">
                <thead>
                    <tr>
                        <th>Archivo</th>
                        <th>Tamaño (KB)</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="files-tbody">
                    <!-- se llena dinámicamente -->
                </tbody>
            </table>
        </div>
    </div>
</main>

<footer>
    <div class="footer-content">
        <p>&copy; 2025 SafeText - Sistema de Detección de Ciberacoso Escolar</p>
        <p>Creado por <strong>Harry Guajan</strong> y <strong>Joel Tinitana</strong></p>
        <p>EPN - Estructura de Datos y Algoritmos II</p>
    </div>
</footer>

<script>
let patterns = [];
let currentPage = 1;
const patternsPerPage = 10;

// ====== Cargar patrones ======
async function loadPatternsFromAPI() {
    try {
        const res = await fetch('/api/patterns');
        const data = await res.json();
        if (data.success) {
            patterns = data.patterns.map(p => ({
                id: p.id,
                mensaje: p.pattern,
                gravedad: p.severity,
                categoria: p.category,
                etiqueta: p.description
            }));
            loadPatterns();
            updatePagination();
        } else {
            alert('Error al cargar patrones: ' + data.error);
        }
    } catch (err) {
        console.error(err);
        alert('No se pudieron cargar los patrones.');
    }
}

function loadPatterns() {
    const tbody = document.getElementById('patterns-tbody');
    tbody.innerHTML = '';
    const startIndex = (currentPage - 1) * patternsPerPage;
    const endIndex = startIndex + patternsPerPage;
    const toShow = patterns.slice(startIndex, endIndex);
    toShow.forEach(p => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${p.id}</td>
            <td>${p.mensaje}</td>
            <td><span class="gravity-badge">${p.gravedad}</span></td>
            <td>${p.categoria}</td>
            <td>${p.etiqueta}</td>
        `;
        tbody.appendChild(row);
    });
}

function updatePagination() {
    const totalPages = Math.ceil(patterns.length / patternsPerPage);
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.className = 'pagination-btn' + (i === currentPage ? ' active' : '');
        btn.textContent = i;
        btn.onclick = () => {
            currentPage = i;
            loadPatterns();
            updatePagination();
        };
        pagination.appendChild(btn);
    }
}

// ====== Listar archivos cargados ======
async function loadFiles() {
    try {
        const res = await fetch('/api/list-files');
        const data = await res.json();
        const tbody = document.getElementById('files-tbody');
        tbody.innerHTML = '';
        if (data.success) {
            data.files.forEach(file => {
                const row = document.createElement('tr');
                // deshabilitar eliminar para patrones.csv
                const disableDelete = file.name === 'patrones.csv';
                row.innerHTML = `
                    <td>${file.name}</td>
                    <td>${file.size}</td>
                    <td>
                        ${disableDelete ? 
                            '<em>Base protegida</em>' :
                            `<button class="btn-action delete-btn" onclick="deleteFile('${file.name}')">Eliminar</button>`}
                    </td>
                `;
                tbody.appendChild(row);
            });
        } else {
            alert('Error al listar archivos: ' + data.error);
        }
    } catch (err) {
        console.error(err);
        alert('No se pudieron listar los archivos.');
    }
}

// ====== Eliminar archivo ======
async function deleteFile(filename) {
    if (!confirm(`¿Eliminar ${filename}?`)) return;
    try {
        const res = await fetch('/api/delete-file', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename })
        });
        const data = await res.json();
        if (data.success) {
            alert(data.message);
            await loadFiles();
            await loadPatternsFromAPI();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (err) {
        console.error(err);
        alert('Error al eliminar archivo.');
    }
}

// ====== Subir archivo ======
document.getElementById('upload-patterns-btn').addEventListener('click', async () => {
    const fileInput = document.getElementById('pattern-file');
    if (fileInput.files.length === 0) {
        alert('Selecciona un archivo CSV o TXT');
        return;
    }
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    try {
        const res = await fetch('/api/upload-patterns', { method: 'POST', body: formData });
        const data = await res.json();
        if (data.success) {
            alert(data.message);
            await loadPatternsFromAPI();
            await loadFiles();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (err) {
        console.error(err);
        alert('Error al subir archivo.');
    }
});

// ====== Inicialización ======
document.addEventListener('DOMContentLoaded', async () => {
    await loadPatternsFromAPI();
    await loadFiles();
});
</script>
</body>
</html>
