<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeText - Resultados del Análisis</title>
    <link rel="stylesheet" href="../static/styles.css">
    <style>
        /* Estilos para la sección de recomendaciones */
        .recommendations-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid #dee2e6;
        }

        .recommendations-section h3 {
            color: #495057;
            margin-bottom: 1.5rem;
            font-size: 1.4rem;
            border-bottom: 2px solid #6c757d;
            padding-bottom: 0.5rem;
        }

        .loading-recommendations {
            text-align: center;
            padding: 2rem;
        }

        .loading-recommendations .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #6c757d;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .recommendations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .recommendation-card {
            background: #ffffff;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e9ecef;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            animation: slideInUp 0.6s ease forwards;
            opacity: 0;
        }

        .recommendation-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
            border-color: #adb5bd;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .recommendation-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            gap: 0.75rem;
        }

        .recommendation-icon {
            font-size: 1.5rem;
            min-width: 2rem;
            color: #6c757d;
        }

        .recommendation-title {
            flex: 1;
            font-size: 1.1rem;
            color: #343a40;
            margin: 0;
            font-weight: 600;
        }

        .priority-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .priority-1 {
            background-color: #495057;
            color: white;
        }

        .priority-2 {
            background-color: #6c757d;
            color: white;
        }

        .priority-3 {
            background-color: #adb5bd;
            color: #495057;
        }

        .recommendation-content {
            line-height: 1.6;
        }

        .recommendation-description {
            color: #6c757d;
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }

        .recommendation-action {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid #6c757d;
            border: 1px solid #e9ecef;
        }

        .recommendation-action strong {
            color: #495057;
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .recommendation-action p {
            margin: 0;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .recommendations-footer {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #dee2e6;
        }

        .recommendation-note {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid #adb5bd;
            border: 1px solid #e9ecef;
        }

        .note-icon {
            font-size: 1.2rem;
            margin-top: 0.1rem;
            color: #6c757d;
        }

        .recommendation-note p {
            margin: 0;
            color: #495057;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* Estilos para loading de recomendaciones */
        .loading-recommendations {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e9ecef;
            border-top: 3px solid #495057;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-recommendations p {
            margin: 0;
            font-size: 0.95rem;
            text-align: center;
        }

        /* Estilos para la recomendación de nivel de riesgo simplificada */
        .risk-level-card {
            background: #ffffff;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e9ecef;
            animation: slideInUp 0.6s ease forwards;
        }

        .risk-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            gap: 0.75rem;
        }

        .risk-icon {
            font-size: 2rem;
            min-width: 2.5rem;
        }

        .risk-title {
            flex: 1;
            font-size: 1.2rem;
            color: #343a40;
            margin: 0;
            font-weight: 600;
        }

        .risk-content {
            line-height: 1.6;
        }

        .risk-description {
            color: #6c757d;
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        .risk-action {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid #6c757d;
            border: 1px solid #e9ecef;
        }

        .risk-action strong {
            color: #495057;
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .risk-action p {
            margin: 0;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .loading-recommendation {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
            color: #6c757d;
        }

        /* Estilos para la recomendación única y resumen */
        .single-recommendation {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .main-recommendation {
            border-left: 4px solid #495057;
        }

        .analysis-summary-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .summary-title {
            color: #495057;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 0.5rem;
        }

        .summary-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 6px;
            font-weight: 600;
        }

        .summary-status.bajo,
        .summary-status.none {
            background-color: #d4edda;
            color: #155724;
        }

        .summary-status.low {
            background-color: #fff3cd;
            color: #856404;
        }

        .summary-status.medium {
            background-color: #ffeaa7;
            color: #6c5ce7;
        }

        .summary-status.high {
            background-color: #fdcb6e;
            color: #e17055;
        }

        .summary-status.critical {
            background-color: #fab1a0;
            color: #d63031;
        }

        .summary-status.desconocido {
            background-color: #e9ecef;
            color: #6c757d;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: currentColor;
        }

        .summary-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            background: white;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .detail-label {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .detail-value {
            font-weight: 600;
            color: #495057;
        }

        .summary-description {
            margin-bottom: 1rem;
        }

        .summary-description p {
            color: #6c757d;
            margin: 0;
            line-height: 1.5;
        }

        .next-steps {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid #6c757d;
            border: 1px solid #e9ecef;
        }

        .next-steps strong {
            color: #495057;
            display: block;
            margin-bottom: 0.5rem;
        }

        .next-steps p {
            margin: 0;
            color: #6c757d;
            font-size: 0.95rem;
        }

        /* Estilos para el tip de revisión manual */
        .manual-review-tip {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            border-left: 4px solid #6c757d;
        }

        .tip-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .tip-icon {
            font-size: 1.2rem;
            color: #6c757d;
        }

        .tip-header h5 {
            margin: 0;
            color: #495057;
            font-size: 1rem;
            font-weight: 600;
        }

        .manual-review-tip p {
            margin: 0;
            color: #6c757d;
            font-size: 0.9rem;
            line-height: 1.5;
            font-style: italic;
        }

        /* Estilos para las categorías en el resumen */
        #categories-list {
            font-weight: 600;
            color: #495057;
        }

        /* Mejorar tooltips de patrones resaltados */
        .highlighted-pattern {
            cursor: help;
            position: relative;
        }

        .highlighted-pattern:hover {
            opacity: 0.8;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .recommendations-grid {
                grid-template-columns: 1fr;
            }
            
            .recommendation-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .priority-badge {
                align-self: flex-start;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>SafeText <span class="subtitle">Sistema de Detección de Ciberacoso Escolar</span></h1>
        </div>
        <div class="header-year">
            <span>EPN 2025</span>
        </div>
    </header>

    <main>
        <div class="results-container">
            <!-- Sección de navegación -->
            <div class="results-nav">
                <a href="index.html" class="btn-back">← Volver al Análisis</a>
                <h2>Resultados del Análisis</h2>
            </div>

            <!-- Texto analizado -->
            <div class="analyzed-text-section">
                <h3>Texto Analizado</h3>
                <div class="analyzed-text-box">
                    <p id="analyzed-text">
                        <!-- El texto analizado se mostrará aquí -->
                        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris.
                    </p>
                </div>
                <div class="text-stats">
                    <span class="stat-item">Caracteres: <strong id="char-count">127</strong></span>
                    <span class="stat-item">Palabras: <strong id="word-count">23</strong></span>
                    <span class="stat-item">Líneas: <strong id="line-count">3</strong></span>
                </div>
            </div>

            <!-- Resultados del análisis -->
            <div class="analysis-results">
                <div class="results-summary">
                    <h3>Resumen del Análisis</h3>
                    <div class="summary-cards">
                        <div class="summary-card safe">
                            <div class="card-icon">✓</div>
                            <div class="card-content">
                                <h4>Contenido Seguro</h4>
                                <p class="percentage" id="safe-percentage">85%</p>
                                <p class="description">No se detectaron patrones de ciberacoso</p>
                            </div>
                        </div>
                        
                        <div class="summary-card warning">
                            <div class="card-icon">⚠</div>
                            <div class="card-content">
                                <h4>Contenido Sospechoso</h4>
                                <p class="percentage" id="warning-percentage">15%</p>
                                <p class="description">Algunos patrones requieren atención</p>
                            </div>
                        </div>
                        
                        <div class="summary-card danger">
                            <div class="card-icon">✕</div>
                            <div class="card-content">
                                <h4>Contenido Peligroso</h4>
                                <p class="percentage" id="danger-percentage">0%</p>
                                <p class="description">Patrones de ciberacoso detectados</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Patrones Detectados (movido aquí después del resumen) -->
                <div class="detection-details">
                    <h3>📊 Patrones Detectados</h3>
                    
                    <!-- Texto con patrones resaltados -->
                    <div class="highlighted-text-container">
                        <h4>Texto Analizado con Patrones Detectados</h4>
                        <div class="highlighted-text" id="highlighted-text">
                            <!-- El texto con patrones resaltados se mostrará aquí -->
                            <p>Cargando análisis...</p>
                        </div>
                    </div>
                    
                    <!-- Resumen compacto -->
                    <div class="detection-summary" id="detection-summary">
                        <div class="summary-item">
                            <span class="summary-label">Patrones encontrados:</span>
                            <span class="summary-value" id="patterns-count">0</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Total coincidencias:</span>
                            <span class="summary-value" id="matches-count">0</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Categorías detectadas:</span>
                            <span class="summary-value" id="categories-list">N/A</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Algoritmos usados:</span>
                            <span class="summary-value" id="algorithms-list">N/A</span>
                        </div>
                    </div>
                </div>

                <!-- Recomendación del Nivel de Riesgo -->
                <div class="recommendations-section">
                    <h3>� Recomendación Según Nivel de Riesgo</h3>
                    <div class="risk-level-recommendation" id="risk-level-recommendation">
                        <!-- La recomendación del nivel se mostrará aquí -->
                        <div class="loading-recommendation">
                            <div class="spinner"></div>
                            <p>Determinando nivel de riesgo...</p>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Acciones -->
            <div class="results-actions">
                <button class="btn-secondary" id="export-report">📄 Exportar Reporte</button>
                <button class="btn-secondary" id="save-results">💾 Guardar Resultados</button>
                <button class="btn-primary" id="new-analysis">🔍 Nuevo Análisis</button>
            </div>
        </div>
    </main>

    <!-- Pie de página -->
    <footer>
        <div class="footer-content">
            <p>&copy; 2025 SafeText - Sistema de Detección de Ciberacoso Escolar</p>
            <p>Creado por <strong>Harry Guajan</strong> y <strong>Joel Tinitana</strong></p>
            <p>Escuela Politécnica Nacional (EPN) - Estructura de Datos y Algoritmos II</p>
            <div class="footer-links">
                <a href="#" class="footer-link">Términos de Uso</a>
                <span class="separator">•</span>
                <a href="#" class="footer-link">Política de Privacidad</a>
                <span class="separator">•</span>
                <a href="#" class="footer-link">Contacto</a>
            </div>
        </div>
    </footer>

    <script>
        // Funcionalidad para los botones de acción
        document.getElementById('new-analysis').addEventListener('click', function() {
            window.location.href = 'index.html';
        });
        
        document.getElementById('export-report').addEventListener('click', function() {
            exportAnalysisReport();
        });
        
        document.getElementById('save-results').addEventListener('click', function() {
            saveAnalysisResults();
        });

        // Función para exportar reporte
        function exportAnalysisReport() {
            const results = localStorage.getItem('analysisResults');
            const analyzedText = localStorage.getItem('analyzedText');
            
            if (!results || !analyzedText) {
                alert('No hay resultados para exportar');
                return;
            }
            
            const data = JSON.parse(results);
            const timestamp = new Date().toLocaleString('es-ES');
            
            let reportContent = `SAFETEXT - REPORTE DE ANÁLISIS DE CIBERACOSO\n`;
            reportContent += `================================================\n\n`;
            reportContent += `Fecha y hora: ${timestamp}\n`;
            reportContent += `Texto analizado: "${analyzedText}"\n`;
            reportContent += `Longitud del texto: ${analyzedText.length} caracteres\n\n`;
            
            reportContent += `RESULTADOS DEL ANÁLISIS:\n`;
            reportContent += `------------------------\n`;
            reportContent += `¿Es ciberacoso?: ${data.is_cyberbullying ? 'SÍ' : 'NO'}\n`;
            reportContent += `Nivel de riesgo: ${data.risk_level}\n`;
            reportContent += `Patrones detectados: ${data.total_patterns_found}\n`;
            reportContent += `Total de coincidencias: ${data.total_matches}\n`;
            
            // Agregar categorías detectadas al reporte
            if (data.matches && data.matches.length > 0) {
                const categoriesFound = [...new Set(data.matches.map(match => match.pattern_info.category))];
                reportContent += `Categorías detectadas: ${categoriesFound.join(', ')}\n`;
            }
            reportContent += `\n`;
            
            if (data.matches && data.matches.length > 0) {
                reportContent += `PATRONES DETECTADOS:\n`;
                reportContent += `-------------------\n`;
                data.matches.forEach((match, index) => {
                    reportContent += `${index + 1}. "${match.pattern_info.pattern}"\n`;
                    reportContent += `   Categoría: ${match.pattern_info.category}\n`;
                    reportContent += `   Severidad: ${match.pattern_info.severity}\n`;
                    reportContent += `   Algoritmo usado: ${match.algorithm_used}\n`;
                    reportContent += `   Coincidencias: ${match.total_matches}\n`;
                    reportContent += `   Posiciones: ${match.positions.join(', ')}\n`;
                    reportContent += `   Descripción: ${match.pattern_info.description}\n\n`;
                });
            }
            
            reportContent += `RESUMEN: ${data.analysis_summary}\n\n`;
            
            // Agregar recomendación al reporte
            const riskCard = document.querySelector('.risk-level-card');
            
            if (riskCard) {
                reportContent += `RECOMENDACIÓN SEGÚN NIVEL DE RIESGO:\n`;
                reportContent += `-----------------------------------\n`;
                
                const title = riskCard.querySelector('.risk-title')?.textContent || 'Recomendación';
                const description = riskCard.querySelector('.risk-description')?.textContent || '';
                const action = riskCard.querySelector('.risk-action p')?.textContent || '';
                const priority = riskCard.querySelector('.priority-badge')?.textContent || 'Media';
                
                reportContent += `Título: ${title}\n`;
                reportContent += `Prioridad: ${priority}\n`;
                reportContent += `Descripción: ${description}\n`;
                reportContent += `Acción: ${action}\n\n`;
            }
            
            reportContent += `---\n`;
            reportContent += `Reporte generado por SafeText - Sistema de Detección de Ciberacoso\n`;
            reportContent += `Desarrollado por Harry Guajan y Joel Tinitana - EPN 2025`;
            
            // Crear y descargar archivo
            const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reporte_ciberacoso_${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('Reporte exportado exitosamente');
        }
        
        // Función para guardar resultados
        function saveAnalysisResults() {
            const results = localStorage.getItem('analysisResults');
            if (results) {
                alert('Resultados guardados en el navegador exitosamente');
            } else {
                alert('No hay resultados para guardar');
            }
        }
        
        // Animación de entrada para las tarjetas
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar texto analizado desde localStorage
            loadAnalyzedText();
            
            // Animaciones
            const cards = document.querySelectorAll('.summary-card, .pattern-item, .recommendation-card');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 100);
            });
        });

        // Función para cargar el texto analizado
        function loadAnalyzedText() {
            const analyzedText = localStorage.getItem('analyzedText');
            
            if (analyzedText) {
                // Mostrar el texto analizado
                document.getElementById('analyzed-text').textContent = analyzedText;
                
                // Calcular estadísticas
                const charCount = analyzedText.length;
                const wordCount = analyzedText.trim().split(/\s+/).filter(word => word.length > 0).length;
                const lineCount = analyzedText.split('\n').length;
                
                // Actualizar estadísticas
                document.getElementById('char-count').textContent = charCount;
                document.getElementById('word-count').textContent = wordCount;
                document.getElementById('line-count').textContent = lineCount;
                
                // Realizar análisis real con el backend
                performRealAnalysis(analyzedText);
            } else {
                // Si no hay texto, mostrar mensaje y redirigir
                alert('No hay texto para analizar. Será redirigido al inicio.');
                window.location.href = 'index.html';
            }
        }

        // Función para realizar análisis real con el backend
        async function performRealAnalysis(text) {
            try {
                // Llamar al backend para análisis
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: text })
                });
                
                if (!response.ok) {
                    throw new Error('Error en el análisis');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    displayAnalysisResults(data.result);
                } else {
                    throw new Error(data.error || 'Error desconocido');
                }
                
            } catch (error) {
                console.error('Error en el análisis:', error);
                // Fallback al análisis básico si hay error
                performBasicAnalysis(text);
                alert('Usando análisis básico - Servidor no disponible');
            }
        }

        // Función para mostrar los resultados del análisis real
        function displayAnalysisResults(result) {
            // Actualizar porcentajes
            updatePercentages(result);
            
            // Crear texto resaltado
            createHighlightedText(result);
            
            // Actualizar resumen de detección
            updateDetectionSummary(result);
            
            // Generar recomendaciones inteligentes
            generateIntelligentRecommendations(result);
            
            // Guardar resultados para exportación
            localStorage.setItem('analysisResults', JSON.stringify(result));
        }

        // Función para generar recomendación del nivel de riesgo desde el backend
        async function generateIntelligentRecommendations(result) {
            const container = document.getElementById('risk-level-recommendation');
            
            try {
                // Mostrar mensaje de carga
                container.innerHTML = `
                    <div class="loading-recommendation">
                        <div class="loading-spinner"></div>
                        <p>Determinando nivel de riesgo...</p>
                    </div>
                `;
                
                // Llamar al backend para obtener recomendación del nivel
                const response = await fetch('/api/recommendations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(result)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Mostrar solo la recomendación del nivel de riesgo
                    displayRiskLevelRecommendation(data.recommendation, container);
                } else {
                    console.error('Error del servidor:', data.error);
                    displayFallbackRiskRecommendation(container);
                }
                
            } catch (error) {
                console.error('Error llamando al backend:', error);
                displayFallbackRiskRecommendation(container);
            }
        }

        // Función para seleccionar recomendaciones por tipo
        function selectRecommendationsByType(type, count) {
            const recommendations = RECOMMENDATIONS_BANK[type] || [];
            return recommendations.slice(0, count);
        }

        // Función para seleccionar recomendaciones por severidad
        function selectRecommendationsBySeverity(severity, count) {
            const recommendations = RECOMMENDATIONS_BANK.severity[severity] || RECOMMENDATIONS_BANK.severity['Low'];
            return recommendations.slice(0, count);
        }

        // Función para seleccionar recomendaciones por categoría
        function selectRecommendationsByCategory(category, count) {
            const recommendations = RECOMMENDATIONS_BANK.categories[category] || [];
            return recommendations.slice(0, count);
        }

        // Función para mostrar una sola recomendación (sin resumen)
        function displaySingleRecommendation(recommendation, container) {
            let html = `
                <div class="single-recommendation">
                    <div class="recommendation-card main-recommendation">
                        <div class="recommendation-header">
                            <span class="recommendation-icon">${recommendation.icon}</span>
                            <h4 class="recommendation-title">${recommendation.title}</h4>
                            <span class="priority-badge priority-${recommendation.priority}">
                                Prioridad ${recommendation.priority === 1 ? 'Alta' : recommendation.priority === 2 ? 'Media' : 'Baja'}
                            </span>
                        </div>
                        <div class="recommendation-content">
                            <p class="recommendation-description">${recommendation.description}</p>
                            <div class="recommendation-action">
                                <strong>Acción recomendada:</strong>
                                <p>${recommendation.action}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="manual-review-tip">
                        <div class="tip-header">
                            <span class="tip-icon">💡</span>
                            <h5>Recomendación General</h5>
                        </div>
                        <p>Se sugiere una revisión manual del contenido. Evalúe el contexto completo de la comunicación y tome medidas apropiadas.</p>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Función de respaldo para mostrar recomendación básica
        function displayFallbackRecommendations(container) {
            const fallbackRec = {
                icon: '�',
                title: 'Educación y Prevención',
                description: 'La educación continua es la mejor herramienta para prevenir el ciberacoso.',
                action: 'Implemente programas de concientización sobre comunicación digital responsable y respeto en línea.',
                priority: 1
            };
            
            displaySingleRecommendation(fallbackRec, container);
        }

        // Función para crear texto con patrones resaltados
        function createHighlightedText(result) {
            const highlightedTextElement = document.getElementById('highlighted-text');
            const originalText = localStorage.getItem('analyzedText') || 'Texto no disponible';
            
            if (!result.matches || result.matches.length === 0) {
                highlightedTextElement.innerHTML = `
                    <p class="no-patterns-text">${originalText}</p>
                    <div class="no-patterns-note">
                        ✅ No se detectaron patrones de ciberacoso en este texto
                    </div>
                `;
                return;
            }
            
            // Crear una copia del texto para modificar
            let highlightedText = originalText;
            
            // Ordenar matches por posición (de mayor a menor para no afectar índices)
            const sortedMatches = [];
            result.matches.forEach(match => {
                match.positions.forEach(pos => {
                    sortedMatches.push({
                        position: pos,
                        pattern: match.pattern_info.pattern,
                        severity: match.pattern_info.severity,
                        category: match.pattern_info.category
                    });
                });
            });
            
            // Ordenar por posición descendente
            sortedMatches.sort((a, b) => b.position - a.position);
            
            // Aplicar resaltado
            sortedMatches.forEach(match => {
                const start = match.position;
                const end = start + match.pattern.length;
                const severityClass = getSeverityClass(match.severity);
                
                const before = highlightedText.substring(0, start);
                const highlighted = highlightedText.substring(start, end);
                const after = highlightedText.substring(end);
                
                highlightedText = before + 
                    `<span class="highlighted-pattern ${severityClass}" title="Categoría: ${match.category} | Patrón: '${match.pattern}' | Severidad: ${match.severity}">${highlighted}</span>` + 
                    after;
            });
            
            highlightedTextElement.innerHTML = `<p>${highlightedText}</p>`;
        }

        // Función para actualizar el resumen de detección
        function updateDetectionSummary(result) {
            document.getElementById('patterns-count').textContent = result.total_patterns_found || 0;
            document.getElementById('matches-count').textContent = result.total_matches || 0;
            
            // Mostrar categorías detectadas
            if (result.matches && result.matches.length > 0) {
                const categoriesFound = [...new Set(result.matches.map(match => match.pattern_info.category))];
                const categoriesText = categoriesFound.length > 0 ? categoriesFound.join(', ') : 'N/A';
                document.getElementById('categories-list').textContent = categoriesText;
            } else {
                document.getElementById('categories-list').textContent = 'N/A';
            }
            
            // Mostrar algoritmos usados
            const algorithmsUsed = result.algorithms_used || {};
            const algorithmsList = Object.keys(algorithmsUsed);
            const algorithmsText = algorithmsList.length > 0 ? 
                algorithmsList.map(algo => `${algo} (${algorithmsUsed[algo]})`).join(', ') : 'N/A';
            document.getElementById('algorithms-list').textContent = algorithmsText;
        }

        // Función para actualizar porcentajes basados en el análisis real
        function updatePercentages(result) {
            let safePercentage, warningPercentage, dangerPercentage;
            
            if (!result.is_cyberbullying) {
                safePercentage = 100;
                warningPercentage = 0;
                dangerPercentage = 0;
            } else {
                // Calcular porcentajes inteligentes basados en múltiples factores
                const textLength = (localStorage.getItem('analyzedText') || '').trim();
                const wordCount = textLength.split(/\s+/).filter(word => word.length > 0).length;
                const patternCount = result.total_patterns_found || 0;
                const totalMatches = result.total_matches || 0;
                
                // Factor 1: Densidad de patrones (patrones únicos por palabra)
                const patternDensity = wordCount > 0 ? (patternCount / wordCount) : 0;
                
                // Factor 2: Densidad de coincidencias (total matches por palabra)
                const matchDensity = wordCount > 0 ? (totalMatches / wordCount) : 0;
                
                // Factor 3: Severidad promedio de los patrones
                let averageSeverity = 0;
                if (result.matches && result.matches.length > 0) {
                    const severityValues = result.matches.map(match => {
                        const severity = match.pattern_info.severity;
                        if (typeof severity === 'string') {
                            switch(severity.toLowerCase()) {
                                case 'critical': return 100;
                                case 'high': return 80;
                                case 'medium': return 60;
                                case 'low': return 40;
                                default: return 50;
                            }
                        }
                        return parseInt(severity) || 50;
                    });
                    averageSeverity = severityValues.reduce((sum, val) => sum + val, 0) / severityValues.length;
                }
                
                // Factor 4: Modificador por longitud del texto
                // Textos muy cortos son más peligrosos con los mismos patrones
                let lengthModifier = 1.0;
                if (wordCount <= 5) {
                    lengthModifier = 1.5; // Textos muy cortos son más peligrosos
                } else if (wordCount <= 15) {
                    lengthModifier = 1.2; // Textos cortos son más peligrosos
                } else if (wordCount <= 50) {
                    lengthModifier = 1.0; // Textos normales
                } else {
                    lengthModifier = 0.8; // Textos largos son menos peligrosos proporcionalmente
                }
                
                // Calcular puntuación base (0-100)
                let dangerScore = 0;
                
                // Contribución de la densidad de patrones (máximo 40 puntos)
                dangerScore += Math.min(patternDensity * 200, 40);
                
                // Contribución de la densidad de coincidencias (máximo 30 puntos)
                dangerScore += Math.min(matchDensity * 150, 30);
                
                // Contribución de la severidad promedio (máximo 30 puntos)
                dangerScore += (averageSeverity / 100) * 30;
                
                // Aplicar modificador por longitud
                dangerScore *= lengthModifier;
                
                // Limitar a máximo 100
                dangerScore = Math.min(dangerScore, 100);
                
                // Calcular porcentajes finales
                if (dangerScore >= 70) {
                    // Muy peligroso
                    dangerPercentage = Math.round(dangerScore);
                    warningPercentage = Math.round((100 - dangerScore) * 0.6);
                    safePercentage = 100 - dangerPercentage - warningPercentage;
                } else if (dangerScore >= 40) {
                    // Moderadamente peligroso
                    dangerPercentage = Math.round(dangerScore * 0.7);
                    warningPercentage = Math.round(dangerScore * 0.8);
                    safePercentage = 100 - dangerPercentage - warningPercentage;
                } else if (dangerScore >= 20) {
                    // Ligeramente peligroso
                    dangerPercentage = Math.round(dangerScore * 0.5);
                    warningPercentage = Math.round(dangerScore * 1.2);
                    safePercentage = 100 - dangerPercentage - warningPercentage;
                } else {
                    // Baja peligrosidad
                    dangerPercentage = Math.round(dangerScore * 0.3);
                    warningPercentage = Math.round(dangerScore);
                    safePercentage = 100 - dangerPercentage - warningPercentage;
                }
                
                // Asegurar que los porcentajes no sean negativos
                safePercentage = Math.max(safePercentage, 0);
                warningPercentage = Math.max(warningPercentage, 0);
                dangerPercentage = Math.max(dangerPercentage, 0);
                
                // Ajustar para que sumen 100%
                const total = safePercentage + warningPercentage + dangerPercentage;
                if (total !== 100) {
                    const factor = 100 / total;
                    safePercentage = Math.round(safePercentage * factor);
                    warningPercentage = Math.round(warningPercentage * factor);
                    dangerPercentage = 100 - safePercentage - warningPercentage;
                }
            }
            
            document.getElementById('safe-percentage').textContent = safePercentage + '%';
            document.getElementById('warning-percentage').textContent = warningPercentage + '%';
            document.getElementById('danger-percentage').textContent = dangerPercentage + '%';
            
            // Actualizar descripciones
            updateRiskDescriptions(result, {
                safe: safePercentage,
                warning: warningPercentage,
                danger: dangerPercentage
            });
        }

        // Funciones auxiliares
        function getSeverityClass(severity) {
            switch (severity) {
                case 'Low': return 'low-risk';
                case 'Medium': return 'medium-risk';
                case 'High': return 'high-risk';
                case 'Critical': return 'critical-risk';
                default: return 'low-risk';
            }
        }

        function getSeverityText(severity) {
            switch (severity) {
                case 'Low': return 'Bajo';
                case 'Medium': return 'Medio';
                case 'High': return 'Alto';
                case 'Critical': return 'Crítico';
                default: return 'Bajo';
            }
        }

        // Función para actualizar descripciones según el nivel de riesgo
        function updateRiskDescriptions(result, percentages) {
            const safeCard = document.querySelector('.summary-card.safe .description');
            const warningCard = document.querySelector('.summary-card.warning .description');
            const dangerCard = document.querySelector('.summary-card.danger .description');
            
            if (!result.is_cyberbullying) {
                safeCard.textContent = 'No se detectaron patrones de ciberacoso';
                warningCard.textContent = 'Sin contenido sospechoso';
                dangerCard.textContent = 'Sin contenido peligroso';
            } else {
                const patternsCount = result.total_patterns_found;
                const matchesCount = result.total_matches;
                const textLength = (localStorage.getItem('analyzedText') || '').trim();
                const wordCount = textLength.split(/\s+/).filter(word => word.length > 0).length;
                
                // Calcular densidad para descripciones más precisas
                const patternDensity = wordCount > 0 ? ((patternsCount / wordCount) * 100).toFixed(1) : 0;
                
                // Descripciones inteligentes basadas en los porcentajes calculados
                if (percentages.danger >= 50) {
                    safeCard.textContent = 'Contenido con alto riesgo de ciberacoso detectado';
                    warningCard.textContent = `${patternsCount} patrones en ${wordCount} palabras (densidad: ${patternDensity}%)`;
                    dangerCard.textContent = `${matchesCount} coincidencias críticas detectadas`;
                } else if (percentages.danger >= 25) {
                    safeCard.textContent = 'Contenido con riesgo moderado de ciberacoso';
                    warningCard.textContent = `${patternsCount} patrones requieren atención`;
                    dangerCard.textContent = `${matchesCount} coincidencias de riesgo medio-alto`;
                } else if (percentages.warning >= 30) {
                    safeCard.textContent = 'Contenido mayormente seguro con observaciones';
                    warningCard.textContent = `${patternsCount} patrón(es) de baja intensidad`;
                    dangerCard.textContent = 'Riesgo bajo pero requiere monitoreo';
                } else {
                    safeCard.textContent = 'Contenido con patrones menores detectados';
                    warningCard.textContent = `${patternsCount} patrón(es) de impacto mínimo`;
                    dangerCard.textContent = 'Sin riesgo significativo identificado';
                }
            }
        }

        // Función para mostrar solo la recomendación del nivel de riesgo
        function displayRiskLevelRecommendation(recommendation, container) {
            let html = `
                <div class="risk-level-card">
                    <div class="risk-header">
                        <span class="risk-icon">${recommendation.icon}</span>
                        <h4 class="risk-title">${recommendation.title}</h4>
                        <span class="priority-badge priority-${recommendation.priority}">
                            Prioridad ${recommendation.priority === 1 ? 'Alta' : recommendation.priority === 2 ? 'Media' : 'Baja'}
                        </span>
                    </div>
                    <div class="risk-content">
                        <p class="risk-description">${recommendation.description}</p>
                        <div class="risk-action">
                            <strong>Acción recomendada:</strong>
                            <p>${recommendation.action}</p>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Función de respaldo para mostrar recomendación básica del nivel
        function displayFallbackRiskRecommendation(container) {
            const fallbackRec = {
                icon: '📚',
                title: 'Educación y Prevención',
                description: 'La educación continua es la mejor herramienta para prevenir el ciberacoso.',
                action: 'Implemente programas de concientización sobre comunicación digital responsable y respeto en línea.',
                priority: 1
            };
            
            displayRiskLevelRecommendation(fallbackRec, container);
        }

        // Función de fallback para análisis básico
        function performBasicAnalysis(text) {
            // Palabras potencialmente problemáticas (básico)
            const problematicWords = [
                'idiota', 'estúpido', 'tonto', 'feo', 'gordo', 'perdedor', 'fracasado', 
                'inútil', 'nadie te quiere', 'vete a morir', 'te voy a pegar', 'cállate',
                'eres un', 'no sirves', 'me da asco', 'patético', 'monstruo'
            ];
            
            const textLower = text.toLowerCase();
            let foundPatterns = [];
            let riskLevel = 0;
            
            // Buscar patrones
            problematicWords.forEach(word => {
                if (textLower.includes(word.toLowerCase())) {
                    foundPatterns.push(word);
                    // Asignar puntos de riesgo según la gravedad
                    if (['vete a morir', 'te voy a pegar'].includes(word)) {
                        riskLevel += 30;
                    } else if (['idiota', 'estúpido', 'inútil', 'nadie te quiere'].includes(word)) {
                        riskLevel += 20;
                    } else {
                        riskLevel += 10;
                    }
                }
            });
            
            // Crear objeto de resultado simulado
            const simulatedResult = {
                is_cyberbullying: foundPatterns.length > 0,
                risk_level: riskLevel >= 60 ? 'Critical' : riskLevel >= 40 ? 'High' : riskLevel >= 20 ? 'Medium' : riskLevel > 0 ? 'Low' : 'None',
                total_patterns_found: foundPatterns.length,
                total_matches: foundPatterns.length,
                matches: foundPatterns.map(pattern => ({
                    pattern_info: {
                        pattern: pattern,
                        category: 'Análisis Básico',
                        severity: riskLevel >= 60 ? 'Critical' : riskLevel >= 40 ? 'High' : riskLevel >= 20 ? 'Medium' : 'Low',
                        description: 'Detección básica sin conexión al servidor'
                    },
                    algorithm_used: 'Análisis Local',
                    total_matches: 1,
                    positions: [0]
                }))
            };
            
            displayAnalysisResults(simulatedResult);
        }
    </script>
</body>
</html>
