<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeText - Resultados del An√°lisis</title>
    <link rel="stylesheet" href="../static/styles.css">
</head>
<body>
    <header>
        <div class="header-content">
            <h1>SafeText <span class="subtitle">Sistema de Detecci√≥n de Ciberacoso Escolar</span></h1>
        </div>
        <div class="header-year">
            <span>EPN 2025</span>
        </div>
    </header>

    <main>
        <div class="results-container">
            <!-- Secci√≥n de navegaci√≥n -->
            <div class="results-nav">
                <a href="index.html" class="btn-back">‚Üê Volver al An√°lisis</a>
                <h2>Resultados del An√°lisis</h2>
            </div>

            <!-- Texto analizado -->
            <div class="analyzed-text-section">
                <h3>Texto Analizado</h3>
                <div class="analyzed-text-box">
                    <p id="analyzed-text">
                        <!-- El texto analizado se mostrar√° aqu√≠ -->
                        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris.
                    </p>
                </div>
                <div class="text-stats">
                    <span class="stat-item">Caracteres: <strong id="char-count">127</strong></span>
                    <span class="stat-item">Palabras: <strong id="word-count">23</strong></span>
                    <span class="stat-item">L√≠neas: <strong id="line-count">3</strong></span>
                </div>
            </div>

            <!-- Resultados del an√°lisis -->
            <div class="analysis-results">
                <div class="results-summary">
                    <h3>Resumen del An√°lisis</h3>
                    <div class="summary-cards">
                        <div class="summary-card safe">
                            <div class="card-icon">‚úì</div>
                            <div class="card-content">
                                <h4>Contenido Seguro</h4>
                                <p class="percentage" id="safe-percentage">85%</p>
                                <p class="description">No se detectaron patrones de ciberacoso</p>
                            </div>
                        </div>
                        
                        <div class="summary-card warning">
                            <div class="card-icon">‚ö†</div>
                            <div class="card-content">
                                <h4>Contenido Sospechoso</h4>
                                <p class="percentage" id="warning-percentage">15%</p>
                                <p class="description">Algunos patrones requieren atenci√≥n</p>
                            </div>
                        </div>
                        
                        <div class="summary-card danger">
                            <div class="card-icon">‚úï</div>
                            <div class="card-content">
                                <h4>Contenido Peligroso</h4>
                                <p class="percentage" id="danger-percentage">0%</p>
                                <p class="description">Patrones de ciberacoso detectados</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Patrones Detectados (movido aqu√≠ despu√©s del resumen) -->
                <div class="detection-details">
                    <h3>üìä Patrones Detectados</h3>
                    
                    <!-- Texto con patrones resaltados -->
                    <div class="highlighted-text-container">
                        <h4>Texto Analizado con Patrones Detectados</h4>
                        <div class="highlighted-text" id="highlighted-text">
                            <!-- El texto con patrones resaltados se mostrar√° aqu√≠ -->
                            <p>Cargando an√°lisis...</p>
                        </div>
                    </div>
                    
                    <!-- Resumen compacto -->
                    <div class="detection-summary" id="detection-summary">
                        <div class="summary-item">
                            <span class="summary-label">Patrones encontrados:</span>
                            <span class="summary-value" id="patterns-count">0</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Total coincidencias:</span>
                            <span class="summary-value" id="matches-count">0</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Algoritmos usados:</span>
                            <span class="summary-value" id="algorithms-list">N/A</span>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Acciones -->
            </div>

            <!-- Acciones -->
            <div class="results-actions">
                <button class="btn-secondary" id="export-report">üìÑ Exportar Reporte</button>
                <button class="btn-secondary" id="save-results">üíæ Guardar Resultados</button>
                <button class="btn-primary" id="new-analysis">üîç Nuevo An√°lisis</button>
            </div>
        </div>
    </main>

    <!-- Pie de p√°gina -->
    <footer>
        <div class="footer-content">
            <p>&copy; 2025 SafeText - Sistema de Detecci√≥n de Ciberacoso Escolar</p>
            <p>Creado por <strong>Harry Guajan</strong> y <strong>Joel Tinitana</strong></p>
            <p>Escuela Polit√©cnica Nacional (EPN) - Estructura de Datos y Algoritmos II</p>
            <div class="footer-links">
                <a href="#" class="footer-link">T√©rminos de Uso</a>
                <span class="separator">‚Ä¢</span>
                <a href="#" class="footer-link">Pol√≠tica de Privacidad</a>
                <span class="separator">‚Ä¢</span>
                <a href="#" class="footer-link">Contacto</a>
            </div>
        </div>
    </footer>

    <script>
        // Funcionalidad para los botones de acci√≥n
        document.getElementById('new-analysis').addEventListener('click', function() {
            window.location.href = 'index.html';
        });
        
        document.getElementById('export-report').addEventListener('click', function() {
            exportAnalysisReport();
        });
        
        document.getElementById('save-results').addEventListener('click', function() {
            saveAnalysisResults();
        });

        // Funci√≥n para exportar reporte
        function exportAnalysisReport() {
            const results = localStorage.getItem('analysisResults');
            const analyzedText = localStorage.getItem('analyzedText');
            
            if (!results || !analyzedText) {
                alert('No hay resultados para exportar');
                return;
            }
            
            const data = JSON.parse(results);
            const timestamp = new Date().toLocaleString('es-ES');
            
            let reportContent = `SAFETEXT - REPORTE DE AN√ÅLISIS DE CIBERACOSO\n`;
            reportContent += `================================================\n\n`;
            reportContent += `Fecha y hora: ${timestamp}\n`;
            reportContent += `Texto analizado: "${analyzedText}"\n`;
            reportContent += `Longitud del texto: ${analyzedText.length} caracteres\n\n`;
            
            reportContent += `RESULTADOS DEL AN√ÅLISIS:\n`;
            reportContent += `------------------------\n`;
            reportContent += `¬øEs ciberacoso?: ${data.is_cyberbullying ? 'S√ç' : 'NO'}\n`;
            reportContent += `Nivel de riesgo: ${data.risk_level}\n`;
            reportContent += `Patrones detectados: ${data.total_patterns_found}\n`;
            reportContent += `Total de coincidencias: ${data.total_matches}\n\n`;
            
            if (data.matches && data.matches.length > 0) {
                reportContent += `PATRONES DETECTADOS:\n`;
                reportContent += `-------------------\n`;
                data.matches.forEach((match, index) => {
                    reportContent += `${index + 1}. "${match.pattern_info.pattern}"\n`;
                    reportContent += `   Categor√≠a: ${match.pattern_info.category}\n`;
                    reportContent += `   Severidad: ${match.pattern_info.severity}\n`;
                    reportContent += `   Algoritmo usado: ${match.algorithm_used}\n`;
                    reportContent += `   Coincidencias: ${match.total_matches}\n`;
                    reportContent += `   Posiciones: ${match.positions.join(', ')}\n`;
                    reportContent += `   Descripci√≥n: ${match.pattern_info.description}\n\n`;
                });
            }
            
            reportContent += `RESUMEN: ${data.analysis_summary}\n\n`;
            reportContent += `---\n`;
            reportContent += `Reporte generado por SafeText - Sistema de Detecci√≥n de Ciberacoso\n`;
            reportContent += `Desarrollado por Harry Guajan y Joel Tinitana - EPN 2025`;
            
            // Crear y descargar archivo
            const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reporte_ciberacoso_${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('Reporte exportado exitosamente');
        }
        
        // Funci√≥n para guardar resultados
        function saveAnalysisResults() {
            const results = localStorage.getItem('analysisResults');
            if (results) {
                alert('Resultados guardados en el navegador exitosamente');
            } else {
                alert('No hay resultados para guardar');
            }
        }
        
        // Animaci√≥n de entrada para las tarjetas
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar texto analizado desde localStorage
            loadAnalyzedText();
            
            // Animaciones
            const cards = document.querySelectorAll('.summary-card, .pattern-item, .recommendation-item');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 100);
            });
        });

        // Funci√≥n para cargar el texto analizado
        function loadAnalyzedText() {
            const analyzedText = localStorage.getItem('analyzedText');
            
            if (analyzedText) {
                // Mostrar el texto analizado
                document.getElementById('analyzed-text').textContent = analyzedText;
                
                // Calcular estad√≠sticas
                const charCount = analyzedText.length;
                const wordCount = analyzedText.trim().split(/\s+/).filter(word => word.length > 0).length;
                const lineCount = analyzedText.split('\n').length;
                
                // Actualizar estad√≠sticas
                document.getElementById('char-count').textContent = charCount;
                document.getElementById('word-count').textContent = wordCount;
                document.getElementById('line-count').textContent = lineCount;
                
                // Realizar an√°lisis real con el backend
                performRealAnalysis(analyzedText);
            } else {
                // Si no hay texto, mostrar mensaje y redirigir
                alert('No hay texto para analizar. Ser√° redirigido al inicio.');
                window.location.href = 'index.html';
            }
        }

        // Funci√≥n para realizar an√°lisis real con el backend
        async function performRealAnalysis(text) {
            try {
                // Llamar al backend para an√°lisis
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: text })
                });
                
                if (!response.ok) {
                    throw new Error('Error en el an√°lisis');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    displayAnalysisResults(data.result);
                } else {
                    throw new Error(data.error || 'Error desconocido');
                }
                
            } catch (error) {
                console.error('Error en el an√°lisis:', error);
                // Fallback al an√°lisis b√°sico si hay error
                performBasicAnalysis(text);
                alert('Usando an√°lisis b√°sico - Servidor no disponible');
            }
        }

        // Funci√≥n para mostrar los resultados del an√°lisis real
        function displayAnalysisResults(result) {
            // Actualizar porcentajes
            updatePercentages(result);
            
            // Crear texto resaltado
            createHighlightedText(result);
            
            // Actualizar resumen de detecci√≥n
            updateDetectionSummary(result);
            
            // Guardar resultados para exportaci√≥n
            localStorage.setItem('analysisResults', JSON.stringify(result));
        }

        // Funci√≥n para crear texto con patrones resaltados
        function createHighlightedText(result) {
            const highlightedTextElement = document.getElementById('highlighted-text');
            const originalText = localStorage.getItem('analyzedText') || 'Texto no disponible';
            
            if (!result.matches || result.matches.length === 0) {
                highlightedTextElement.innerHTML = `
                    <p class="no-patterns-text">${originalText}</p>
                    <div class="no-patterns-note">
                        ‚úÖ No se detectaron patrones de ciberacoso en este texto
                    </div>
                `;
                return;
            }
            
            // Crear una copia del texto para modificar
            let highlightedText = originalText;
            
            // Ordenar matches por posici√≥n (de mayor a menor para no afectar √≠ndices)
            const sortedMatches = [];
            result.matches.forEach(match => {
                match.positions.forEach(pos => {
                    sortedMatches.push({
                        position: pos,
                        pattern: match.pattern_info.pattern,
                        severity: match.pattern_info.severity,
                        category: match.pattern_info.category
                    });
                });
            });
            
            // Ordenar por posici√≥n descendente
            sortedMatches.sort((a, b) => b.position - a.position);
            
            // Aplicar resaltado
            sortedMatches.forEach(match => {
                const start = match.position;
                const end = start + match.pattern.length;
                const severityClass = getSeverityClass(match.severity);
                
                const before = highlightedText.substring(0, start);
                const highlighted = highlightedText.substring(start, end);
                const after = highlightedText.substring(end);
                
                highlightedText = before + 
                    `<span class="highlighted-pattern ${severityClass}" title="${match.category}: ${match.pattern}">${highlighted}</span>` + 
                    after;
            });
            
            highlightedTextElement.innerHTML = `<p>${highlightedText}</p>`;
        }

        // Funci√≥n para actualizar el resumen de detecci√≥n
        function updateDetectionSummary(result) {
            document.getElementById('patterns-count').textContent = result.total_patterns_found || 0;
            document.getElementById('matches-count').textContent = result.total_matches || 0;
            
            // Mostrar algoritmos usados
            const algorithmsUsed = result.algorithms_used || {};
            const algorithmsList = Object.keys(algorithmsUsed);
            const algorithmsText = algorithmsList.length > 0 ? 
                algorithmsList.map(algo => `${algo} (${algorithmsUsed[algo]})`).join(', ') : 'N/A';
            document.getElementById('algorithms-list').textContent = algorithmsText;
        }

        // Funci√≥n para actualizar porcentajes basados en el an√°lisis real
        function updatePercentages(result) {
            let safePercentage, warningPercentage, dangerPercentage;
            
            if (!result.is_cyberbullying) {
                safePercentage = 100;
                warningPercentage = 0;
                dangerPercentage = 0;
            } else {
                // Calcular porcentajes basados en el nivel de riesgo
                switch (result.risk_level) {
                    case 'Low':
                        safePercentage = 70;
                        warningPercentage = 30;
                        dangerPercentage = 0;
                        break;
                    case 'Medium':
                        safePercentage = 50;
                        warningPercentage = 40;
                        dangerPercentage = 10;
                        break;
                    case 'High':
                        safePercentage = 30;
                        warningPercentage = 30;
                        dangerPercentage = 40;
                        break;
                    case 'Critical':
                        safePercentage = 10;
                        warningPercentage = 20;
                        dangerPercentage = 70;
                        break;
                    default:
                        safePercentage = 90;
                        warningPercentage = 10;
                        dangerPercentage = 0;
                }
            }
            
            document.getElementById('safe-percentage').textContent = safePercentage + '%';
            document.getElementById('warning-percentage').textContent = warningPercentage + '%';
            document.getElementById('danger-percentage').textContent = dangerPercentage + '%';
            
            // Actualizar descripciones
            updateRiskDescriptions(result);
        }

        // Funciones auxiliares
        function getSeverityClass(severity) {
            switch (severity) {
                case 'Low': return 'low-risk';
                case 'Medium': return 'medium-risk';
                case 'High': return 'high-risk';
                case 'Critical': return 'critical-risk';
                default: return 'low-risk';
            }
        }

        function getSeverityText(severity) {
            switch (severity) {
                case 'Low': return 'Bajo';
                case 'Medium': return 'Medio';
                case 'High': return 'Alto';
                case 'Critical': return 'Cr√≠tico';
                default: return 'Bajo';
            }
        }

        // Funci√≥n para actualizar descripciones seg√∫n el nivel de riesgo
        function updateRiskDescriptions(result) {
            const safeCard = document.querySelector('.summary-card.safe .description');
            const warningCard = document.querySelector('.summary-card.warning .description');
            const dangerCard = document.querySelector('.summary-card.danger .description');
            
            if (!result.is_cyberbullying) {
                safeCard.textContent = 'No se detectaron patrones de ciberacoso';
                warningCard.textContent = 'Sin contenido sospechoso';
                dangerCard.textContent = 'Sin contenido peligroso';
            } else {
                const patternsCount = result.total_patterns_found;
                const matchesCount = result.total_matches;
                
                switch (result.risk_level) {
                    case 'Low':
                        safeCard.textContent = 'Mayormente seguro con observaciones menores';
                        warningCard.textContent = `${patternsCount} patr√≥n(es) de riesgo bajo detectado(s)`;
                        dangerCard.textContent = 'Sin contenido altamente peligroso';
                        break;
                    case 'Medium':
                        safeCard.textContent = 'Contenido con riesgos moderados';
                        warningCard.textContent = `${patternsCount} patr√≥n(es) requieren atenci√≥n`;
                        dangerCard.textContent = 'Algunos patrones de riesgo medio detectados';
                        break;
                    case 'High':
                        safeCard.textContent = 'Contenido con alto riesgo de ciberacoso';
                        warningCard.textContent = `${patternsCount} patrones problem√°ticos detectados`;
                        dangerCard.textContent = `${matchesCount} coincidencias de alto riesgo`;
                        break;
                    case 'Critical':
                        safeCard.textContent = 'Contenido extremadamente peligroso';
                        warningCard.textContent = 'M√∫ltiples patrones cr√≠ticos detectados';
                        dangerCard.textContent = `${matchesCount} patrones de ciberacoso confirmados`;
                        break;
                    default:
                        safeCard.textContent = 'Contenido analizado sin clasificaci√≥n';
                        warningCard.textContent = `${patternsCount} patr√≥n(es) detectado(s)`;
                        dangerCard.textContent = 'Revisar manualmente';
                }
            }
        }

        // Funci√≥n de fallback para an√°lisis b√°sico
        function performBasicAnalysis(text) {
            // Palabras potencialmente problem√°ticas (b√°sico)
            const problematicWords = [
                'idiota', 'est√∫pido', 'tonto', 'feo', 'gordo', 'perdedor', 'fracasado', 
                'in√∫til', 'nadie te quiere', 'vete a morir', 'te voy a pegar', 'c√°llate',
                'eres un', 'no sirves', 'me da asco', 'pat√©tico', 'monstruo'
            ];
            
            const textLower = text.toLowerCase();
            let foundPatterns = [];
            let riskLevel = 0;
            
            // Buscar patrones
            problematicWords.forEach(word => {
                if (textLower.includes(word.toLowerCase())) {
                    foundPatterns.push(word);
                    // Asignar puntos de riesgo seg√∫n la gravedad
                    if (['vete a morir', 'te voy a pegar'].includes(word)) {
                        riskLevel += 30;
                    } else if (['idiota', 'est√∫pido', 'in√∫til', 'nadie te quiere'].includes(word)) {
                        riskLevel += 20;
                    } else {
                        riskLevel += 10;
                    }
                }
            });
            
            // Crear objeto de resultado simulado
            const simulatedResult = {
                is_cyberbullying: foundPatterns.length > 0,
                risk_level: riskLevel >= 60 ? 'Critical' : riskLevel >= 40 ? 'High' : riskLevel >= 20 ? 'Medium' : riskLevel > 0 ? 'Low' : 'None',
                total_patterns_found: foundPatterns.length,
                total_matches: foundPatterns.length,
                matches: foundPatterns.map(pattern => ({
                    pattern_info: {
                        pattern: pattern,
                        category: 'An√°lisis B√°sico',
                        severity: riskLevel >= 60 ? 'Critical' : riskLevel >= 40 ? 'High' : riskLevel >= 20 ? 'Medium' : 'Low',
                        description: 'Detecci√≥n b√°sica sin conexi√≥n al servidor'
                    },
                    algorithm_used: 'An√°lisis Local',
                    total_matches: 1,
                    positions: [0]
                }))
            };
            
            displayAnalysisResults(simulatedResult);
        }
    </script>
</body>
</html>
